trigger:
  branches:
    include:
      - main

variables:
  imageName: knowledgecity-backend
  aksCluster: backend-cluster
  aksNamespace: knowledgecity
  resourceGroup: backend-rg

stages:

  # ------------------------
  # Build & Push to ACR
  # ------------------------
  - stage: Build
    displayName: "Build and Push Docker Image"
    jobs:
      - job: DockerBuildPush
        displayName: "Build and Push Image to ACR"
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: Docker@2
            displayName: Build & Push Image
            inputs:
              command: buildAndPush
              repository: $(imageName)
              containerRegistry: container-pipeline
              Dockerfile: backend/Dockerfile
              tags: |
                $(Build.BuildId)

  # ------------------------
  # Trivy Image Scan
  # ------------------------
  - stage: SecurityScan
    displayName: "Run Trivy Scan"
    dependsOn: Build
    jobs:
      - template: .azuredevops/pipelines/templates/security-scan.yml
        parameters:
          imageName: $(imageName)
          imageTag: $(Build.BuildId)

  # ------------------------
  # Deploy to AKS
  # ------------------------
  - stage: Deploy
    displayName: "Deploy to AKS"
    dependsOn: SecurityScan
    jobs:
      - job: DeployToAKS
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: Kubernetes@1
            displayName: "Deploy manifests to AKS"
            inputs:
              connectionType: Azure Resource Manager
              azureSubscriptionEndpoint: azurerm-aks-connection
              azureResourceGroup: $(resourceGroup)
              kubernetesCluster: $(aksCluster)
              namespace: $(aksNamespace)
              command: apply
              useConfigurationFile: true
              configuration: |
                deployment/base/deployment.yaml
                deployment/base/service.yaml
