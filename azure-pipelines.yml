trigger:
  branches:
    include:
      - main

variables:
  imageName: knowledgecity-backend
  aksCluster: backend-cluster
  aksNamespace: knowledgecity
  resourceGroup: aks-rg  # âœ… Corrected RG for AKS
  acrName: backendcntainer.azurecr.io

stages:

  # ------------------------
  # Build & Push to ACR
  # ------------------------
  - stage: Build
    displayName: "Build and Push Docker Image"
    jobs:
      - job: DockerBuildPush
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: Docker@2
            displayName: Build & Push Docker Image
            inputs:
              command: buildAndPush
              repository: $(imageName)
              containerRegistry: container-pipeline
              dockerfile: backend/Dockerfile
              buildContext: backend
              tags: |
                $(Build.BuildId)
                latest

  # ------------------------
  # Trivy Image Scan
  # ------------------------
  - stage: SecurityScan
    displayName: "Security Scan (Trivy)"
    dependsOn: Build
    jobs:
      - template: .azuredevops/pipelines/templates/security-scan.yml
        parameters:
          imageName: $(imageName)
          imageTag: $(Build.BuildId)

  # ------------------------
  # Deploy to AKS
  # ------------------------
  - stage: Deploy
    displayName: "Deploy to AKS"
    dependsOn: SecurityScan
    jobs:
      - job: DeployToAKS
        pool:
          vmImage: 'ubuntu-latest'
        steps:

          - task: Kubernetes@1
            displayName: Update AKS Deployment
            inputs:
              connectionType: Azure Resource Manager
              azureSubscriptionEndpoint: azurerm-aks-connection
              azureResourceGroup: $(resourceGroup)
              kubernetesCluster: $(aksCluster)
              namespace: $(aksNamespace)
              command: apply
              useConfigurationFile: true
              configuration: |
                deployment/base/deployment.yaml
                deployment/base/service.yaml
