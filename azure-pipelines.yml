trigger:
  branches:
    include:
      - main

variables:
  imageName: knowledgecity-backend
  containerRegistry: backendcntainer.azurecr.io
  aksCluster: backend-cluster
  aksNamespace: knowledgecity

stages:

# -----------------------
# ✅ BUILD + PUSH
# -----------------------
  - stage: Build
    displayName: "Build & Push Docker Image"
    jobs:
      - job: BuildAndPush
        pool:
          vmImage: 'ubuntu-latest'
        steps:

        - task: Docker@2
          displayName: "Build and Push image to ACR"
          inputs:
            command: buildAndPush
            containerRegistry: container-pipeline   # ✅ Your ACR Service Connection
            repository: $(imageName)
            Dockerfile: backend/Dockerfile
            tags: |
              $(Build.BuildId)
              latest

# -----------------------
# ✅ TRIVY SCAN
# -----------------------
  - stage: SecurityScan
    dependsOn: Build
    displayName: "Run Trivy Security Scan"
    jobs:
      - template: .azuredevops/pipelines/templates/security-scan.yml

# -----------------------
# ✅ DEPLOY TO AKS
# -----------------------
  - stage: Deploy
    dependsOn: SecurityScan
    displayName: "Deploy to AKS"
    jobs:
      - job: DeployToAKS
        pool:
          vmImage: 'ubuntu-latest'
        steps:

        - task: Kubernetes@1
          displayName: "Deploy Application"
          inputs:
            connectionType: Azure Resource Manager
            azureSubscriptionEndpoint: azurerm-aks-connection   # ✅ AzureRM type
            azureResourceGroup: backend-rg
            kubernetesCluster: backend-cluster
            namespace: $(aksNamespace)
            command: apply
            useConfigurationFile: true
            configuration: |
              deployment/base/deployment.yaml
              deployment/base/service.yaml
