trigger:
  branches:
    include:
      - main

variables:
  imageName: knowledgecity-backend
  containerRegistry: backendcntainer.azurecr.io
  aksCluster: backend-cluster
  aksNamespace: knowledgecity

stages:
  - stage: Build
    displayName: "Build and Push Docker Image"
    jobs:
      - job: DockerBuildPush
        displayName: "Build and Push Image to ACR"
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: Docker@2
            displayName: Build Docker image
            inputs:
              command: build
              Dockerfile: backend/Dockerfile
              tags: |
                $(containerRegistry)/$(imageName):$(Build.BuildId)

          - task: Docker@2
            displayName: Push Docker image to ACR
            inputs:
              command: push
              azureContainerRegistry: container-pipeline
              tags: |
                $(containerRegistry)/$(imageName):$(Build.BuildId)

  - stage: SecurityScan
    displayName: "Run Trivy Scan"
    dependsOn: Build
    jobs:
      - template: .azuredevops/pipelines/templates/security-scan.yml

  - stage: Deploy
    displayName: "Deploy to AKS"
    dependsOn: SecurityScan
    jobs:
      - job: DeployToAKS
        displayName: "Deploy Kubernetes"
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: Kubernetes@1
            displayName: Apply K8s manifests
            inputs:
              connectionType: Azure Resource Manager
              azureSubscriptionEndpoint: azurerm-aks-connection
              azureResourceGroup: 'backend-rg'
              kubernetesCluster: 'backend-cluster'
              namespace: 'knowledgecity'
              command: apply
              useConfigurationFile: true
              configuration: |
                deployment/base/deployment.yaml
                deployment/base/service.yaml
