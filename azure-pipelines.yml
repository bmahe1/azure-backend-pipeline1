trigger:
  branches:
    include:
      - main

variables:
  tag: '$(Build.BuildId)'
  acrName: 'backendazure'
  imageName: 'knowledgecity-backend'
  image: '$(acrName).azurecr.io/$(imageName):$(tag)'

pool:
  vmImage: ubuntu-latest

steps:
- task: Docker@2
  displayName: 🛠 Build Docker Image
  inputs:
    containerRegistry: 'repo'   # ✅ FIX: Use correct service connection
    repository: $(imageName)                  # ✅ FIX: repo only, not full URL
    command: build
    Dockerfile: '**/Dockerfile'
    tags: |
      $(tag)

- task: Docker@2
  displayName: 🚀 Push Docker Image
  inputs:
    containerRegistry: 'repo'   # ✅ FIX: Same service connection
    repository: $(imageName)
    command: push
    tags: |
      $(tag)

- task: AzureCLI@2
  displayName: ⚙️ Deploy to AKS
  inputs:
    azureSubscription: 'docker-connection1'   # ✅ Same connection to AKS
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      az aks get-credentials -g aks-rg -n Backend-cluster --overwrite-existing
      echo "Deploying IMAGE: $(image)"
      chmod +x deployment/scripts/deploy.sh
      ./deployment/scripts/deploy.sh $(image) default
