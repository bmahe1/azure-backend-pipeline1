# Build, scan, and push Docker image to Azure Container Registry

trigger:
  - main

resources:
  - repo: self

variables:
  dockerRegistryServiceConnection: 'cnfront1'
  imageRepository: 'second'
  containerRegistry: 'cnfront.azurecr.io'
  dockerfilePath: 'backend/Dockerfile'
  tag: '$(Build.BuildId)'
  vmImageName: 'ubuntu-latest'

stages:
# ======== BUILD & PUSH IMAGE =========
- stage: Build
  displayName: "Build, Scan & Push"
  jobs:
  - job: Build
    pool:
      vmImage: $(vmImageName)

    steps:
    # Build Java Application
    - task: Maven@4
      displayName: "Build Maven Artifact"
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'clean install -DskipTests=true'
        publishJUnitResults: true
        testResultsFiles: '**/surefire-reports/TEST-*.xml'
        javaHomeOption: 'JDKVersion'
        mavenVersionOption: 'Default'

    # Login to ACR
    - task: Docker@2
      displayName: "Login to ACR"
      inputs:
        command: login
        containerRegistry: $(dockerRegistryServiceConnection)

    # Build Docker image with full ACR path
    - task: Docker@2
      displayName: "Build Docker Image"
      inputs:
        command: build
        containerRegistry: $(dockerRegistryServiceConnection)
        repository: $(containerRegistry)/$(imageRepository)
        dockerfile: $(dockerfilePath)
        tags: |
          $(tag)

    # Push Docker image (full ACR path)
    - task: Docker@2
      displayName: "Push Docker Image to ACR"
      inputs:
        command: push
        containerRegistry: $(dockerRegistryServiceConnection)
        repository: $(containerRegistry)/$(imageRepository)
        tags: |
          $(tag)

    # Publish deployment manifests (K8s YAML)
    - publish: manifests
      artifact: manifests

# ======== DEPLOY TO AKS (placeholder) =========
- stage: Deploy
  displayName: "Deploy to AKS"
  dependsOn: Build
  condition: succeeded()
  jobs:
    - job: Deploy
      displayName: "Deploy to Kubernetes"
      steps:
      - script: echo "Deployment steps will be added soon..."
