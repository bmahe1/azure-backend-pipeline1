# azure-pipelines.yml
trigger:
  branches:
    include:
    - main
    - develop

variables:
  # Docker configuration
  dockerRegistryServiceConnection: 'DockerHubConnection'
  imageRepository: 'maheshbmahesh/backendrepo'
  dockerfilePath: 'Dockerfile'
  tag: '$(Build.BuildId)'
  
  # Application
  k8sNamespace: 'default'

stages:
- stage: Build
  displayName: 'Build and Scan'
  jobs:
  - job: Build
    displayName: 'Build Docker Image'
    pool:
      vmImage: 'ubuntu-latest'
    
    steps:
    # 1. Checkout code
    - checkout: self
      clean: true
    
    # 2. Set up Java
    - task: JavaToolInstaller@0
      displayName: 'Install Java 11'
      inputs:
        versionSpec: '11'
        jdkArchitectureOption: 'x64'
        jdkSourceOption: 'PreInstalled'
    
    # 3. Build with Maven
    - task: Maven@4
      displayName: 'Build Application'
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'clean package'
        options: '-DskipTests=false'
        publishJUnitResults: true
        testResultsFiles: '**/target/surefire-reports/TEST-*.xml'
    
    # 4. Build Docker Image
    - task: Docker@2
      displayName: 'Build Docker Image'
      inputs:
        command: build
        dockerfile: '$(dockerfilePath)'
        repository: '$(imageRepository)'
        tags: |
          $(tag)
          latest
        arguments: '--pull'
    
    # 5. Security Scan (using template)
    - template: .azuredevops/pipelines/templates/security-scan.yml
      parameters:
        imageName: '$(imageRepository):$(tag)'
        severityThreshold: 'HIGH,CRITICAL'
        failOnVulnerabilities: true
    
    # 6. Push to Docker Hub
    - task: Docker@2
      displayName: 'Push Docker Image'
      inputs:
        command: push
        repository: '$(imageRepository)'
        tags: |
          $(tag)
          latest
      condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    
    # 7. Publish Build Artifacts
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Deployment Files'
      inputs:
        targetPath: '$(System.DefaultWorkingDirectory)/deployment'
        artifact: 'k8s-manifests'
        publishLocation: 'pipeline'

- stage: Deploy
  displayName: 'Deploy to Kubernetes'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: DeployK8s
    displayName: 'Deploy to Cluster'
    environment: 'TestFourids'
    strategy:
      runOnce:
        deploy:
          steps:
          # 1. Download manifests
          - download: current
            artifact: 'k8s-manifests'
          
          # 2. Create Docker secret
          - task: Kubernetes@1
            displayName: 'Create Docker Registry Secret'
            inputs:
              connectionType: 'Kubernetes Service Connection'
              kubernetesServiceEndpoint: 'cluster2'
              command: 'create'
              arguments: 'secret docker-registry docker-hub-secret --docker-server=https://index.docker.io/v1/ --docker-username=$(dockerUsername) --docker-password=$(dockerPassword) --docker-email=$(dockerEmail)'
            
          # 3. Apply Kubernetes manifests
          - task: Kubernetes@1
            displayName: 'Apply Kubernetes Manifests'
            inputs:
              connectionType: 'Kubernetes Service Connection'
              kubernetesServiceEndpoint: 'cluster2'
              command: 'apply'
              arguments: '-f $(Pipeline.Workspace)/k8s-manifests/'
