trigger:
  branches:
    include:
      - main

variables:
  tag: '$(Build.BuildId)'
  acrName: 'backendazure'
  imageName: 'knowledgecity-backend'

pool:
  vmImage: ubuntu-latest

steps:
- task: Docker@2
  displayName: üõ† Build Docker Image
  inputs:
    containerRegistry: 'docker-connection1'
    repository: '$(acrName).azurecr.io/$(imageName)'
    command: build
    Dockerfile: '**/Dockerfile'
    tags: |
      $(tag)

- task: Docker@2
  displayName: üöÄ Push Image to ACR
  inputs:
    containerRegistry: 'docker-connection1'
    repository: '$(acrName).azurecr.io/$(imageName)'
    command: push
    tags: |
      $(tag)

- task: AzureCLI@2
  displayName: ‚öôÔ∏è Deploy to AKS
  inputs:
    azureSubscription: 'docker-connection1'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      az aks get-credentials -g aks-rg -n Backend-cluster --overwrite-existing

      IMAGE="$(acrName).azurecr.io/$(imageName):$(tag)"
      echo "Deploying image: $IMAGE"

      chmod +x deployment/scripts/deploy.sh
      ./deployment/scripts/deploy.sh $IMAGE default
